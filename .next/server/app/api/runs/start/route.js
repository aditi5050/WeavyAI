"use strict";(()=>{var e={};e.id=165,e.ids=[165],e.modules={2934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},4580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},5869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6005:e=>{e.exports=require("node:crypto")},7561:e=>{e.exports=require("node:fs")},9411:e=>{e.exports=require("node:path")},6516:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>I,patchFetch:()=>z,requestAsyncStorage:()=>N,routeModule:()=>E,serverHooks:()=>y,staticGenerationAsyncStorage:()=>h});var r={};a.r(r),a.d(r,{POST:()=>f});var o=a(9303),s=a(8716),n=a(670),i=a(6837),u=a(7070),d=a(3493),l=a(6091);async function c(e,t){console.log(`[ENGINE] Starting run ${e}`);let a=await d.Z.workflowRun.findUnique({where:{id:e},include:{workflow:{include:{nodes:!0,edges:!0}},nodeExecutions:!0}});if(!a){console.error(`[ENGINE] Run ${e} not found`);return}await d.Z.workflowRun.update({where:{id:e},data:{status:"RUNNING",startedAt:new Date}});let r=a.workflow.nodes,o=a.workflow.edges,s=a.nodeExecutions,n=e=>s.find(t=>t.nodeId===e),i=e=>{let t=o.filter(t=>t.targetId===e);return 0===t.length||t.every(e=>{let t=n(e.sourceId);return t?.status==="COMPLETED"})},u=!0;for(;u;){u=!1;let e=r.filter(e=>{let t=n(e.id);return t?.status==="PENDING"&&i(e.id)});e.length>0&&(console.log(`[ENGINE] Found ${e.length} ready nodes: ${e.map(e=>e.label).join(", ")}`),await Promise.all(e.map(async e=>{let a=n(e.id);await d.Z.nodeExecution.update({where:{id:a.id},data:{status:"RUNNING",startedAt:new Date}}),a.status="RUNNING";try{let r=o.filter(t=>t.targetId===e.id),s={...t,...e.config};for(let e of r){let t=n(e.sourceId);t?.outputs&&Object.assign(s,t.outputs)}let i={},l=Date.now();switch(e.type){case"llm":i=await p({prompt:s.text||s.prompt||"Default Prompt"});break;case"crop_image":i=await w({imageUrl:s.url});break;case"extract_frame":i=await g({videoUrl:s.url});break;case"upload_image":case"upload_video":i=await m({filename:"upload"});break;case"text":i={text:e.config?.text};break;default:console.warn(`Unknown node type ${e.type}`),i={status:"skipped"}}let c=Date.now()-l;await d.Z.nodeExecution.update({where:{id:a.id},data:{status:"COMPLETED",completedAt:new Date,duration:c,inputs:s,outputs:i}}),a.status="COMPLETED",a.outputs=i,u=!0}catch(t){console.error(`[ENGINE] Node ${e.id} failed`,t),await d.Z.nodeExecution.update({where:{id:a.id},data:{status:"FAILED",error:String(t),completedAt:new Date}}),a.status="FAILED"}})))}let l=s.every(e=>"COMPLETED"===e.status||"SKIPPED"===e.status);s.some(e=>"FAILED"===e.status)?await d.Z.workflowRun.update({where:{id:e},data:{status:"FAILED",completedAt:new Date}}):l&&await d.Z.workflowRun.update({where:{id:e},data:{status:"COMPLETED",completedAt:new Date}}),console.log(`[ENGINE] Run ${e} finished`)}let p=async e=>(console.log("Executing LLM Task",e),await new Promise(e=>setTimeout(e,1e3)),{text:"This is a mocked LLM response for "+e.prompt}),w=async e=>(console.log("Executing Crop Task",e),await new Promise(e=>setTimeout(e,1500)),{url:"https://via.placeholder.com/500x500?text=Cropped+Image"}),g=async e=>(console.log("Executing Extract Frame Task",e),await new Promise(e=>setTimeout(e,2e3)),{url:"https://via.placeholder.com/1920x1080?text=Extracted+Frame"}),m=async e=>(console.log("Executing Upload Task",e),await new Promise(e=>setTimeout(e,500)),{url:"https://via.placeholder.com/original?text=Uploaded+Asset"}),x=async(e,t)=>{c(e,t)};async function f(e){try{let{userId:t}=await (0,i.I)();if(!t)return new u.NextResponse("Unauthorized",{status:401});let a=await e.json(),r=l.B.safeParse(a);if(!r.success)return new u.NextResponse("Invalid request body",{status:400});let{workflowId:o,inputs:s}=r.data,n=await d.Z.workflow.findUnique({where:{id:o},include:{nodes:!0}});if(!n)return new u.NextResponse("Not Found",{status:404});if(n.userId!==t)return new u.NextResponse("Forbidden",{status:403});let c=await d.Z.workflowRun.create({data:{workflowId:o,userId:t,status:"PENDING",nodeExecutions:{create:n.nodes.map(e=>({nodeId:e.id,status:"PENDING"}))}}});return x(c.id,s).catch(e=>{console.error("Failed to trigger workflow",e)}),u.NextResponse.json({runId:c.id})}catch(e){return console.error("[RUN_START]",e),new u.NextResponse("Internal Error",{status:500})}}let E=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/runs/start/route",pathname:"/api/runs/start",filename:"route",bundlePath:"app/api/runs/start/route"},resolvedPagePath:"/workspaces/www.weavy.ai/app/api/runs/start/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:N,staticGenerationAsyncStorage:h,serverHooks:y}=E,I="/api/runs/start/route";function z(){return(0,n.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:h})}},3493:(e,t,a)=>{a.d(t,{Z:()=>o});let r=require("@prisma/client"),o=globalThis.prisma??new r.PrismaClient},6091:(e,t,a)=>{a.d(t,{B:()=>s,R:()=>o});var r=a(7410);let o=r.z.object({id:r.z.string().optional(),name:r.z.string().min(1,"Name is required"),description:r.z.string().optional(),definition:r.z.record(r.z.any()),nodes:r.z.array(r.z.object({id:r.z.string(),type:r.z.string(),label:r.z.string(),position:r.z.object({x:r.z.number(),y:r.z.number()}),data:r.z.record(r.z.any()).optional()})),edges:r.z.array(r.z.object({id:r.z.string(),source:r.z.string(),target:r.z.string(),sourceHandle:r.z.string().nullable().optional(),targetHandle:r.z.string().nullable().optional()}))}),s=r.z.object({workflowId:r.z.string().uuid(),inputs:r.z.record(r.z.any()).optional()})}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[276,972,837,410],()=>a(6516));module.exports=r})();